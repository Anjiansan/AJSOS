     1 00000000                                 [FORMAT "WCOFF"]    ;制作目标文件的模式
     2 00000000                                 [INSTRSET "i486p"]  ;说明使用486指令
     3 00000000                                 [BITS 32]   ;制作32位模式用的机械语言
     4 00000000                                 
     5 00000000                                 ;制作目标文件的信息
     6 00000000                                 [FILE "naskfunc.nas"]   ;源文件名信息
     7 00000000                                     ;GLOBAL _io_hlt,_write_mem8      ;程序中包含的函数名
     8 00000000                                     GLOBAL _io_hlt,_io_cli,_io_sti,_io_stihlt
     9 00000000                                     GLOBAL _io_in8,_io_in16,_io_in32
    10 00000000                                     GLOBAL _io_out8,_io_out16,_io_out32
    11 00000000                                     GLOBAL _io_load_eflags,_io_store_eflags
    12 00000000                                     GLOBAL _load_gdtr,_load_idtr
    13 00000000                                     GLOBAL _load_cr0,_store_cr0
    14 00000000                                     GLOBAL _asm_inthandler21,_asm_inthandler27,_asm_inthandler2c
    15 00000000                                     GLOBAL _memtest_sub
    16 00000000                                     EXTERN _inthandler21,_inthandler27,_inthandler2c
    17 00000000                                 
    18 00000000                                 ;实际的函数
    19                                          [SECTION .text]         ;目标文件中写了这些之后再写程序
    20 00000000                                 _io_hlt:                ;void io_hlt(void);
    21 00000000 F4                                  HLT
    22 00000001 C3                                  RET
    23 00000002                                 
    24 00000002                                 ;_write_mem8:            ;void write_mem8(int addr, int data);
    25 00000002                                 ;    MOV ECX,[ESP+4]     ;[ESP+4]中存放的时地址,将其读入ECX
    26 00000002                                 ;    MOV AL,[ESP+8]      ;[ESP+8]中存放的是数据.将其读入AL
    27 00000002                                 ;    MOV [ECX],AL
    28 00000002                                 ;    RET
    29 00000002                                 
    30 00000002                                 _io_cli:                 ;void io_cli(void);
    31 00000002 FA                                  CLI
    32 00000003 C3                                  RET
    33 00000004                                 
    34 00000004                                 _io_sti:                 ;void io_sti(void);
    35 00000004 FB                                  STI
    36 00000005 C3                                  RET
    37 00000006                                 
    38 00000006                                 _io_stihlt:              ;void io_stihlt(void);
    39 00000006 FB                                  STI
    40 00000007 F4                                  HLT
    41 00000008 C3                                  RET
    42 00000009                                 
    43 00000009                                 _io_in8:                ;int io_in8(int port);
    44 00000009 8B 54 24 04                         MOV EDX,[ESP+4]     ;port
    45 0000000D B8 00000000                         MOV EAX,0
    46 00000012 EC                                  IN AL,DX
    47 00000013 C3                                  RET
    48 00000014                                 
    49 00000014                                 _io_in16:               ;int io_in16(int port);
    50 00000014 8B 54 24 04                         MOV EDX,[ESP+4]     ;port
    51 00000018 B8 00000000                         MOV EAX,0
    52 0000001D 66 ED                               IN AX,DX
    53 0000001F                                 
    54 0000001F                                 _io_in32:               ;int io_in32(int port);
    55 0000001F 8B 54 24 04                         MOV EDX,[ESP+4]     ;port
    56 00000023 ED                                  IN EAX,DX
    57 00000024 C3                                  RET
    58 00000025                                 
    59 00000025                                 _io_out8:               ;void io_out8(int port,int data);
    60 00000025 8B 54 24 04                         MOV EDX,[ESP+4]     ;port
    61 00000029 8A 44 24 08                         MOV AL,[ESP+8]     ;data
    62 0000002D EE                                  OUT DX,AL
    63 0000002E C3                                  RET
    64 0000002F                                 
    65 0000002F                                 _io_out16:              ;void io_out16(int port,int data);
    66 0000002F 8B 54 24 04                         MOV EDX,[ESP+4]     ;port
    67 00000033 8B 44 24 08                         MOV EAX,[ESP+8]     ;data
    68 00000037 66 EF                               OUT DX,AX
    69 00000039 C3                                  RET
    70 0000003A                                 
    71 0000003A                                 _io_out32:              ;void io_out32(int port,int data);
    72 0000003A 8B 54 24 04                         MOV EDX,[ESP+4]     ;port
    73 0000003E 8B 44 24 08                         MOV EAX,[ESP+8]     ;data
    74 00000042 EF                                  OUT DX,EAX
    75 00000043 C3                                  RET
    76 00000044                                 
    77 00000044                                 _io_load_eflags:        ;int io_load_eflags(void);
    78 00000044 9C                                  PUSHFD              ;指 PUSH EFLAGS
    79 00000045 58                                  POP EAX
    80 00000046 C3                                  RET
    81 00000047                                 
    82 00000047                                 _io_store_eflags:       ;void io_store_eflags(int eflags);
    83 00000047 8B 44 24 04                         MOV EAX,[ESP+4]
    84 0000004B 50                                  PUSH EAX
    85 0000004C 9D                                  POPFD               ;指 POP EFLAGS
    86 0000004D C3                                  RET
    87 0000004E                                 
    88 0000004E                                 _load_gdtr:             ;void load_gdtr(int limit,int addr);
    89 0000004E 66 8B 44 24 04                      MOV AX,[ESP+4]      ;limit
    90 00000053 66 89 44 24 06                      MOV [ESP+6],AX
    91 00000058 0F 01 54 24 06                      LGDT [ESP+6]
    92 0000005D C3                                  RET
    93 0000005E                                 
    94 0000005E                                 _load_idtr:             ;void load_idtr(int limit,int addr);
    95 0000005E 66 8B 44 24 04                      MOV AX,[ESP+4]      ;limit
    96 00000063 66 89 44 24 06                      MOV [ESP+6],AX
    97 00000068 0F 01 5C 24 06                      LIDT [ESP+6]
    98 0000006D C3                                  RET
    99 0000006E                                 
   100 0000006E                                 _load_cr0:              ;void load_cr0(void);
   101 0000006E 0F 20 C0                            MOV EAX,CR0
   102 00000071 C3                                  RET
   103 00000072                                 
   104 00000072                                 _store_cr0:             ;void store_cr0(int cr0);
   105 00000072 8B 44 24 04                         MOV EAX,[ESP+4]
   106 00000076 0F 22 C0                            MOV CR0,EAX
   107 00000079 C3                                  RET
   108 0000007A                                 
   109 0000007A                                 _asm_inthandler21:
   110 0000007A 06                                  PUSH ES
   111 0000007B 1E                                  PUSH DS
   112 0000007C 60                                  PUSHAD
   113 0000007D 89 E0                               MOV EAX,ESP
   114 0000007F 50                                  PUSH EAX
   115 00000080 66 8C D0                            MOV AX,SS
   116 00000083 8E D8                               MOV DS,AX
   117 00000085 8E C0                               MOV ES,AX
   118 00000087 E8 [00000000]                       CALL _inthandler21
   119 0000008C 58                                  POP EAX
   120 0000008D 61                                  POPAD
   121 0000008E 1F                                  POP DS
   122 0000008F 07                                  POP ES
   123 00000090 CF                                  IRETD
   124 00000091                                 
   125 00000091                                 _asm_inthandler27:
   126 00000091 06                                  PUSH ES
   127 00000092 1E                                  PUSH DS
   128 00000093 60                                  PUSHAD
   129 00000094 89 E0                               MOV EAX,ESP
   130 00000096 50                                  PUSH EAX
   131 00000097 66 8C D0                            MOV AX,SS
   132 0000009A 8E D8                               MOV DS,AX
   133 0000009C 8E C0                               MOV ES,AX
   134 0000009E E8 [00000000]                       CALL _inthandler27
   135 000000A3 58                                  POP EAX
   136 000000A4 61                                  POPAD
   137 000000A5 1F                                  POP DS
   138 000000A6 07                                  POP ES
   139 000000A7 CF                                  IRETD
   140 000000A8                                 
   141 000000A8                                 _asm_inthandler2c:
   142 000000A8 06                                  PUSH ES
   143 000000A9 1E                                  PUSH DS
   144 000000AA 60                                  PUSHAD
   145 000000AB 89 E0                               MOV EAX,ESP
   146 000000AD 50                                  PUSH EAX
   147 000000AE 66 8C D0                            MOV AX,SS
   148 000000B1 8E D8                               MOV DS,AX
   149 000000B3 8E C0                               MOV ES,AX
   150 000000B5 E8 [00000000]                       CALL _inthandler2c
   151 000000BA 58                                  POP EAX
   152 000000BB 61                                  POPAD
   153 000000BC 1F                                  POP DS
   154 000000BD 07                                  POP ES
   155 000000BE CF                                  IRETD
   156 000000BF                                 
   157 000000BF                                 _memtest_sub:           ;unsigned int memtest_sub(unsigned int start,unsigned int end);
   158 000000BF 57                                  PUSH EDI            ;(由于还要使用EBX,ESI,EDI)
   159 000000C0 56                                  PUSH ESI
   160 000000C1 53                                  PUSH EBX
   161 000000C2 BE AA55AA55                         MOV ESI,0xAA55AA55  ;pat0=0xAA55AA55;
   162 000000C7 BF 55AA55AA                         MOV EDI,0x55AA55AA  ;pat1=0x55AA55AA;
   163 000000CC 8B 44 24 10                         MOV EAX,[ESP+12+4]  ;i=start;
   164 000000D0                                 mts_loop:
   165 000000D0 89 C3                               MOV EBX,EAX
   166 000000D2 81 C3 00000FFC                      ADD EBX,0xFFC       ;p=i+0xFFC;
   167 000000D8 8B 13                               MOV EDX,[EBX]       ;old=*p;
   168 000000DA 89 33                               MOV [EBX],ESI       ;*p=pat0
   169 000000DC 83 33 FF                            XOR DWORD [EBX],0xFFFFFFFF      ;*p ^= 0xFFFFFFFF;
   170 000000DF 3B 3B                               CMP EDI,[EBX]       ;if(*p!=pat1) goto fin;
   171 000000E1 75 18                               JNE mts_fin
   172 000000E3 83 33 FF                            XOR DWORD [EBX],0xFFFFFFFF      ;*p ^= 0xFFFFFFFF;
   173 000000E6 3B 33                               CMP ESI,[EBX]       ;if(*p!=pat0) goto fin;
   174 000000E8 75 11                               JNE mts_fin
   175 000000EA 89 13                               MOV [EBX],EDX       ;*p=old;
   176 000000EC 05 00001000                         ADD EAX,0x1000      ;i+=0x1000
   177 000000F1 3B 44 24 14                         CMP EAX,[ESP+12+8]  ;if(i<=end) goto mts_loop
   178 000000F5 76 D9                               JBE mts_loop
   179 000000F7 5B                                  POP EBX
   180 000000F8 5E                                  POP ESI
   181 000000F9 5F                                  POP EDI
   182 000000FA C3                                  RET
   183 000000FB                                 mts_fin:
   184 000000FB 89 13                               MOV [EBX],EDX       ;*p=old;
   185 000000FD 5B                                  POP EBX
   186 000000FE 5E                                  POP ESI
   187 000000FF 5F                                  POP EDI
   188 00000100 C3                                  RET
